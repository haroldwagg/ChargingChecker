<html>
<head>
<!--
  <link href="https://fonts.googleapis.com/css?family=Raleway:400,300,600,800,900" rel="stylesheet" type="text/css">
-->
  <script src="progressbar.js"></script>
  <script type="text/javascript" src="Insomnia.js"></script>
  <script type="text/javascript" src="cordova.js"></script>
  <style>
    #container {
      margin: auto;
      width: 300px;
      height: 300px;
      position: relative;
      margin-top: 2em;
    }
    body {
      background-color: #303030;
    }
    #settingsDiv {
      position: absolute;
      bottom: 0;
      width: 100%;
      height: 90px;
      background-color: #ccc;
      padding-bottom: 15px;
    }
    #settingsP {
      text-align: center;
    }
  </style>

</head>
<body background-color="#333333">


<div id="container"></div>
<div id="chargingIndicatorDiv" style="text-align: center;">
  <img src="" id="chargingIndicator" style="visibility: hidden; width: 7em; margin-top: 20px;" />
</div>

<div id="settingsDiv">
  <p id="settingsP">
    Chime every &nbsp;&nbsp;<input style="width: 38%" type="range" min="0" max="30" value="12" step="2" class="slider" id="delayRange" oninput="displayDelayTime(this.value)" />&nbsp;&nbsp; <span id="delayMsg">4 mins</span>
    <br />
    <select id="manualChimes" onChange="manualDing(this)">
      <option selected disabled>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Hear the Chimes</option>
      <option value="fullcharge">Play FULL CHARGE Chime</option>
      <option value="upper">Play CHARGING Chime</option>
      <option value="downer">Play NOT CHARGING Chime</option>
      <option value="nochange">Play NO CHANGE Chime</option>
    </select>
    <br />
      Volume: &nbsp;&nbsp;<input type="range" min="0" max="1.0" value="0.6" step="0.1" class="slider" id="volumeRange" oninput="adjustVolume(this.value)" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<input type="checkbox" id="speakCheck" onClick="doSpeakPercent()" /> Speak %
  </p>

</div>

<script>
  // progressbar.js@1.0.0 version is used
  // Docs: http://progressbarjs.readthedocs.org/en/1.0.0/

  var SIZE;
  var ORIENT;
  var ratio = window.devicePixelRatio || 1;

  var value;
  var bar;
  var batteryValue;
  var PLUGGED_STATUS;

  var UP_DING = "audio/UpBeep.mp3";
  var DOWN_DING = "audio/DownBeep.mp3";
  var NC_DING = "audio/NoChangeBeep.mp3";
  var CHARGED_DING = "audio/FullCharge.mp3";
  var COUNTDOWN_FILE = "audio/countwav.wav";
  var CHARGING_FILE = "audio/Charging.mp3";
  var DISCONNECTED_FILE = "audio/ChargerDisconnected.mp3";
  var CHARGED_FILE = "audio/Charged.mp3";
  var DING_DELAY = 240000;
  var SPEAK_PERCENT = false;
  var MEDIA_READY = false;
  var safeToDing = true;
  var failSafe = 0;
  var CURRENT_VOLUME = 0.6;
  var SPEAK_PERCENT;

  var myColors = [
    "#ff0000",
    "#ff0000",
    "#ff0000",
    "#ff0000",
    "#ff0000",
    "#ff0000",
    "#ff0000",
    "#ff0000",
    "#ff0000",
    "#ff0000",
    "#ff0000",
    "#ff0000",
    "#ff0000",
    "#ff0000",
    "#ff0000",
    "#ff0000",
    "#ff0000",
    "#ff0000",
    "#ff0000",
    "#ff0000",
    "#ff0000",
    "#ff0000",
    "#ff0000",
    "#ff0000",
    "#ff0000",
    "#ff0000",
    "#ff0000",
    "#ff0000",
    "#ff0000",
    "#ff0000",
    "#ff0000",
    "#ff0000",
    "#ff0000",
    "#ff0000",
    "#ff0000",
    "#ff0000",
    "#ff0000",
    "#ff0000",
    "#ff0000",
    "#ff0000",
    "#ff1200",
    "#ff2400",
    "#ff3700",
    "#ff4900",
    "#ff5b00",
    "#ff6d00",
    "#ff8000",
    "#ff9200",
    "#ffa400",
    "#ffb600",
    "#ffc800",
    "#ffdb00",
    "#ffed00",
    "#ffff00",
    "#ffff00",
    "#ffff00",
    "#ffff00",
    "#ffff00",
    "#ffff00",
    "#ffff00",
    "#ffff00",
    "#ffff00",
    "#ffff00",
    "#ffff00",
    "#ffff00",
    "#ffff00",
    "#ffff00",
    "#ffff00",
    "#ffff00",
    "#ffff00",
    "#ffff00",
    "#ffff00",
    "#ffff00",
    "#ffff00",
    "#ffff00",
    "#ffff00",
    "#edfe00",
    "#dbfd00",
    "#c8fc00",
    "#b6fb00",
    "#a4fa00",
    "#92f900",
    "#80f800",
    "#6df700",
    "#5bf600",
    "#49f500",
    "#37f400",
    "#24f300",
    "#12f200",
    "#00f200",
    "#00f200",
    "#00f200",
    "#00f200",
    "#00f200",
    "#00f200",
    "#00f200",
    "#00f200",
    "#00f200",
    "#00f200",
    "#00f200",
    "#0000ee"
  ];

//  document.addEventListener("deviceready", starter, false);
  window.onload = setTimeout(function() {starter();}, 1000);
  window.addEventListener("orientationchange", onOChange);

  function starter()   {
    alert('starter');
    window.plugins.insomnia.keepAwake();
    onOChange();
    initializeBar();
  }

  function initializeBar()   {
    bar = new ProgressBar.Circle(container, {
      color: '#eee',
      // This has to be the same size as the maximum width to
      // prevent clipping
      strokeWidth: 8,
      trailWidth: 3,
      // easing: 'easeInOut',
      easing: 'easeInOut',
      duration: 5400,
      text: {
        autoStyleContainer: false
      },
      from: { color: '#aaa', width: 3 },
      to: { color: '#333', width: 8 },
      // Set default step function for all animate calls
      step: function(state, circle) {
        value = Math.round(circle.value() * 100);

        circle.path.setAttribute('stroke', myColors[value]);
        circle.path.setAttribute('stroke-width', state.width);

         if (value === 0) {
          circle.setText('');
        } else {
          circle.setText(value + "%");
        }
      }
    });
    bar.text.style.fontFamily = 'sans-serif';
    bar.text.style.fontSize = '4rem';
    bar.text.style.fontWeight = 'bold';
    bar.text.style.color = '#cccccc';

    doAReading();

  }

  function getScreenSize()   {
    var ratio = window.devicePixelRatio || 1;
    if ((screen.height / ratio > 780) || (screen.width / ratio > 780))   {
      SIZE = "big";
    }
    else   {
      SIZE = "small";
    }
  }

  function doScreenSpecs()  {
    var oput = "ORIENTATION: " + ORIENT + "\rSCREEN WIDTH: " + screen.width;
    oput += "\rSCREEN HEIGHT: " + screen.height + "\rPIXEL RATIO: " + ratio;
    alert (oput);
  }

  function onOChange()   {
    ORIENT = (screen.height > screen.width) ? "portrait" : "landscape";

    getScreenSize();

    if (ORIENT == "landscape")   {
      var useableHeight = window.innerHeight - 105;
      var containerDim = Math.floor(useableHeight - 350);
      containerDim = Math.floor(containerDim / ratio);
      document.getElementById('container').style.marginTop = '.75em';

      if (SIZE == "small")   {
        document. getElementById('chargingIndicator').style.width = '4em';
        document. getElementById('chargingIndicator').style.marginTop = '10px';
      }
    }
    else   {  // portrait
      var useableWidth = screen.width;
      var containerDim = Math.floor(useableWidth);
      containerDim = Math.floor((containerDim / ratio) * 1.2);
      if (SIZE == "small")   {
        document. getElementById('chargingIndicator').style.width = '7em';
      }
      var tMargin = (screen.height - 270 - containerDim) / 2;

      var v = "document.getElementById('container').style.marginTop = '" + Math.floor(tMargin) + "px'";
      eval(v);
    }

    var s = "document.getElementById('container').style.width = '" + containerDim + "px'";
    eval(s)
    var t = "document.getElementById('container').style.height = '" + containerDim + "px'";
    eval(t);
  }

//  alert("screen.height = " + screen.height + "\nscreen.availHeight = " + screen.availHeight + "\nwindow.innerHeight = " + window.innerHeight + "\ndocument.body.clientHeight = " + document.body.clientHeight + "\nwindow.outerHeight = " + window.outerHeight + "\n\nscreen.width = " + screen.width + "\nscreen.availWidth = " + screen.availWidth + "\nwindow.innerWidth = " + window.innerWidth + "\ndocument.body.clientWidth = " + document.body.clientWidth + "\nwindow.outerWidth = " + window.outerWidth);



//  bar.animate(batteryValue/100);  // Number from 0.0 to 1.0

  function displayDelayTime(theValue)   {
    let tempp = theValue / 18.258;
    let tempp2 = tempp * tempp * 11.112;
    var minuteDelay = Math.floor(tempp2);

    if (minuteDelay == 0)   {
      document.getElementById('delayMsg').innerHTML = "OFF&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;";
//          clearTimeout(dingLooper);
    }
    else   {
      document.getElementById('delayMsg').innerHTML = minuteDelay + " mins";
//          DING_DELAY = minuteDelay * 60 * 1000;
//          clearTimeout(dingLooper);
//          dingTimer("none");
    }
  }

  function doAReading()   {
    navigator.getBattery().then(function(battery) {
      batteryValue = Math.round(battery.level * 100);
      PLUGGED_STATUS = battery.charging;
      bar.animate(batteryValue/100);

      if (PLUGGED_STATUS)   {
        document.getElementById('chargingIndicator').src = "chargedACTIVE.png";
      }
      else   {
        document.getElementById('chargingIndicator').src = "nochargingINACTIVE.png";
      }

      document.getElementById('chargingIndicator').style.visibility = "visible";

        battery.onchargingchange = function() { onChargeChg(); };

        battery.onlevelchange = function() {
          batteryValue = Math.round(battery.level * 100);
          bar.animate(batteryValue/100);
        };
      }
    );
  }

  function doDing(dir, noPercent)   {
// alert(dir);

    var dingFile = "";
    var my_dinger;
    noPercent = noPercent || false;

    if (safeToDing)   {
      safeToDing = false;
      if (SPEAK_PERCENT && ! noPercent)   {
        var Percenter = setTimeout(talkPercent, 1250);
      }

      if (dir == "disconnected")   {
        dingFile = this.root + DISCONNECTED_FILE;
      }
      else if (dir == "charging")   {
        dingFile = this.root + CHARGING_FILE;
      }
      else if (dir == "downer")   {
        dingFile = this.root + DOWN_DING;
      }
      else if (dir == "upper")   {
        dingFile = this.root + UP_DING;
      }
      else if (dir == "nochange")   {
        dingFile = this.root + NC_DING;
      }
      else if (dir == "fullcharge")   {
        dingFile = this.root + CHARGED_DING;
      }

      my_dinger = new Media(dingFile,
          ignoreError(),
          ignoreError()
        );

      my_dinger.play({ playAudioWhenScreenIsLocked : true });
      my_dinger.setVolume(CURRENT_VOLUME);

      var Timeouter = setTimeout(function()   {
        my_dinger.stop();
        my_dinger.release();
        safeToDing = true;
      }, 2000);
    }
  }

  function manualDing(sel)   {
    doDing(sel.options[sel.selectedIndex].value, true);
  }

  function onChargeChg()   {
    navigator.getBattery().then(function(battery) {
      PLUGGED_STATUS = battery.charging;
      if (battery.charging)   {
        doDing('charging', true);
        document.getElementById('chargingIndicator').src = "chargedACTIVE.png";
      }
      else   {
        doDing('disconnected', true);
        document.getElementById('chargingIndicator').src = "nochargingINACTIVE.png";
      }
    });
  }





</script>

<!--
<a href='https://pngtree.com/so/battery-icons'>battery-icons png from pngtree.com</a>
-->

</body>
</html>
